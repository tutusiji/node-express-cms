# PM2 é¡¹ç›®å¯åŠ¨æŒ‡å—

æœ¬é¡¹ç›®åŒ…å«å¤šä¸ª Node.js åº”ç”¨ï¼Œä½¿ç”¨ PM2 è¿›ç¨‹ç®¡ç†å™¨è¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚

## ğŸ“‹ é¡¹ç›®ç»“æ„

- **server** - Express åç«¯æœåŠ¡ï¼ˆç«¯å£ï¼šéœ€æŸ¥çœ‹é…ç½®ï¼‰
- **server-gpt** - GPT æœåŠ¡ï¼ˆç«¯å£ï¼šéœ€æŸ¥çœ‹é…ç½®ï¼‰
- **web-ssr** - SSR åº”ç”¨ï¼ˆç«¯å£ï¼šéœ€æŸ¥çœ‹é…ç½®ï¼‰
- **admin** - Vue å‰ç«¯ç®¡ç†åå°ï¼ˆéœ€æ„å»ºï¼‰

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£… PM2ï¼ˆå…¨å±€ï¼‰

```bash
npm install -g pm2
```

### 2. ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
# æ–¹å¼ä¸€ï¼šä½¿ç”¨æ¨èçš„å¯åŠ¨è„šæœ¬ï¼ˆä½¿ç”¨ç”Ÿæ€ç³»ç»Ÿé…ç½®ï¼‰
bash start-pm2.sh

# æ–¹å¼äºŒï¼šä½¿ç”¨ç®€å•å¯åŠ¨è„šæœ¬
bash start-all.sh
```

### 3. éªŒè¯æœåŠ¡çŠ¶æ€

```bash
pm2 list
```

## ğŸ“ å¸¸ç”¨å‘½ä»¤

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
pm2 logs

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
pm2 logs server
pm2 logs server-gpt
pm2 logs ssr-app

# å®æ—¶ç›‘æ§æ—¥å¿—
pm2 logs --lines 100 --follow
```

### ç®¡ç†æœåŠ¡

```bash
# åœæ­¢æ‰€æœ‰æœåŠ¡
pm2 stop all

# é‡å¯æ‰€æœ‰æœåŠ¡
pm2 restart all

# åœæ­¢ç‰¹å®šæœåŠ¡
pm2 stop server

# é‡å¯ç‰¹å®šæœåŠ¡
pm2 restart server

# åˆ é™¤æ‰€æœ‰æœåŠ¡
pm2 delete all

# åˆ é™¤ç‰¹å®šæœåŠ¡
pm2 delete server
```

### ç›‘æ§å’Œç»´æŠ¤

```bash
# å®æ—¶ç›‘æ§èµ„æºä½¿ç”¨
pm2 monit

# æŸ¥çœ‹è¿›ç¨‹è¯¦ç»†ä¿¡æ¯
pm2 info server

# ä¿å­˜å½“å‰è¿›ç¨‹åˆ—è¡¨
pm2 save

# æ¢å¤ä¿å­˜çš„è¿›ç¨‹åˆ—è¡¨
pm2 resurrect

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save
```

## ğŸ”§ é…ç½®æ–‡ä»¶è¯´æ˜

### pm2-ecosystem.config.js

è¿™æ˜¯ PM2 çš„ç”Ÿæ€ç³»ç»Ÿé…ç½®æ–‡ä»¶ï¼Œå®šä¹‰äº†æ‰€æœ‰åº”ç”¨çš„å¯åŠ¨å‚æ•°ï¼š

- **instances**: è¿›ç¨‹å®ä¾‹æ•°ï¼ˆcluster æ¨¡å¼ä¸‹ï¼‰
- **exec_mode**: æ‰§è¡Œæ¨¡å¼ï¼ˆfork æˆ– clusterï¼‰
- **env**: ç¯å¢ƒå˜é‡
- **watch**: ç›‘å¬æ–‡ä»¶å˜åŒ–è‡ªåŠ¨é‡å¯
- **ignore_watch**: å¿½ç•¥ç›‘å¬çš„æ–‡ä»¶/ç›®å½•
- **max_memory_restart**: å†…å­˜è¶…è¿‡é™åˆ¶æ—¶è‡ªåŠ¨é‡å¯
- **error_file/out_file**: æ—¥å¿—æ–‡ä»¶è·¯å¾„

## ğŸ“Š ä½¿ç”¨ç®¡ç†è„šæœ¬

```bash
# äº¤äº’å¼ç®¡ç†èœå•
bash manage-pm2.sh

# æˆ–ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°
bash manage-pm2.sh start      # å¯åŠ¨æ‰€æœ‰æœåŠ¡
bash manage-pm2.sh stop       # åœæ­¢æ‰€æœ‰æœåŠ¡
bash manage-pm2.sh restart    # é‡å¯æ‰€æœ‰æœåŠ¡
bash manage-pm2.sh list       # æŸ¥çœ‹è¿›ç¨‹åˆ—è¡¨
bash manage-pm2.sh logs       # æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
bash manage-pm2.sh monit      # ç›‘æ§èµ„æº
bash manage-pm2.sh startup    # è®¾ç½®å¼€æœºè‡ªå¯
bash manage-pm2.sh save       # ä¿å­˜è¿›ç¨‹åˆ—è¡¨
```

## ğŸ› æ•…éšœæ’æŸ¥

### æœåŠ¡æ— æ³•å¯åŠ¨

1. æ£€æŸ¥ä¾èµ–æ˜¯å¦å®‰è£…ï¼š
   ```bash
   cd /var/www/node-express-blog/server
   npm install
   ```

2. æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼š
   ```bash
   pm2 logs server --err
   ```

3. æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼š
   ```bash
   lsof -i :3000  # æ£€æŸ¥ 3000 ç«¯å£
   ```

### å†…å­˜å ç”¨è¿‡é«˜

1. æŸ¥çœ‹è¿›ç¨‹å†…å­˜ä½¿ç”¨ï¼š
   ```bash
   pm2 monit
   ```

2. è°ƒæ•´ max_memory_restart å‚æ•°åœ¨ pm2-ecosystem.config.js ä¸­

3. é‡å¯æœåŠ¡ï¼š
   ```bash
   pm2 restart all
   ```

### æ—¥å¿—æ–‡ä»¶è¿‡å¤§

1. æ¸…ç†æ—¥å¿—ï¼š
   ```bash
   pm2 flush
   ```

2. é…ç½®æ—¥å¿—è½®è½¬ï¼ˆåœ¨ pm2-ecosystem.config.js ä¸­æ·»åŠ ï¼‰

## ğŸ” å®‰å…¨å»ºè®®

1. **å®šæœŸå¤‡ä»½è¿›ç¨‹é…ç½®**ï¼š
   ```bash
   pm2 save
   ```

2. **ç›‘æ§èµ„æºä½¿ç”¨**ï¼š
   ```bash
   pm2 monit
   ```

3. **è®¾ç½®å†…å­˜é™åˆ¶**ï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® `max_memory_restart`

4. **å®šæœŸæ£€æŸ¥æ—¥å¿—**ï¼š
   ```bash
   pm2 logs
   ```

## ğŸ“Œ å¼€æœºè‡ªå¯è®¾ç½®

```bash
# 1. è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup

# 2. ä¿å­˜å½“å‰è¿›ç¨‹åˆ—è¡¨
pm2 save

# 3. éªŒè¯è®¾ç½®
pm2 startup

# 4. é‡å¯ç³»ç»ŸåéªŒè¯
pm2 list
```

## ğŸ”„ æ›´æ–°åº”ç”¨

```bash
# 1. æ›´æ–°ä»£ç 
cd /var/www/node-express-blog
git pull

# 2. å®‰è£…æ–°ä¾èµ–ï¼ˆå¦‚æœ‰ï¼‰
npm install

# 3. é‡å¯æœåŠ¡
pm2 restart all
```

## ğŸ“ è·å–å¸®åŠ©

```bash
# PM2 å¸®åŠ©
pm2 help

# æŸ¥çœ‹ç‰¹å®šå‘½ä»¤å¸®åŠ©
pm2 help start
pm2 help logs
```

---

**æœ€åæ›´æ–°**: 2025-11-30
